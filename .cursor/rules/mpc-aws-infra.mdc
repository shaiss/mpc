---
description: AWS CDK architecture and deployment context for NEAR MPC nodes
globs: cross-chain-simulator/cross-chain-simulator/mpc-repo/infra/aws-cdk/**/*
---
# NEAR MPC AWS Infrastructure (CDK Implementation)

This rule provides context for the AWS CDK deployment of NEAR MPC nodes within the `near/mpc` repository.

**Location**: `/Users/Shai.Perednik/Documents/code_workspace/near_mobile/cross-chain-simulator/cross-chain-simulator/mpc-repo/infra/aws-cdk`

## Architecture
- **Goal**: Deploy 3 NEAR MPC nodes on AWS using ECS Fargate.
- **Components**:
    - **Compute**: Amazon ECS on Fargate. 3 separate Services (`node-0`, `node-1`, `node-2`) to maintain stable identity and addressing.
    - **Networking**: AWS Cloud Map (Service Discovery) for stable DNS (`node-0.mpc-nodes-v1.local`).
    - **Storage**: Amazon EFS with 3 Access Points (one per node) mounted to `/data`.
    - **Secrets**: AWS Secrets Manager. Individual secrets for `MPC_ACCOUNT_SK`, `MPC_P2P_PRIVATE_KEY`, `MPC_CIPHER_PK`, `MPC_SIGN_SK`, `MPC_SECRET_STORE_KEY`.
    - **Image**: `nearone/mpc-node-gcp:testnet-release`.

## Current Status
- **Stack Name**: `MpcStandaloneStack`.
- **Deployment Issue**: Fails with `NotStabilized`. Tasks likely crashing or failing health checks.
- **Configuration**:
    - `vpcId` passed from context (integrating with `AWSNodeRunner`).
    - Secrets are created with placeholders ("PLACEHOLDER_REPLACE_ME"). The application might crash if it tries to use these immediately.
    - Container environment variables inject these secrets.

## Key Files
- `lib/mpc-network.ts`: Main construct defining the ECS cluster, services, EFS, and secrets.
- `lib/mpc-standalone-stack.ts`: Stack wrapper.
- `bin/mpc-app.ts`: Entry point.

## Known Constraints
- **Static Addressing**: Node 0 must be reachable at a stable address by Node 1 and 2. Cloud Map is used for this.
- **Secrets Injection**: The MPC node binary expects specific environment variables or GCP Secret Manager access. We are injecting AWS Secrets Manager values into env vars.
